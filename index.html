<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡è³‡è¨Šè§€æ¸¬</title>
    <style>
        :root {
            --bg-dark: #1a1a1b;
            --bg-panel: #2d2d2e;
            --bg-hover: #3d3d3f;
            --primary: #3b82f6;
            --accent: #f59e0b;
            --danger: #ef4444;
            --success: #10b981;
            --text-main: #e0e0e0;
            --text-sub: #aaa;
            --border: #444;
        }
        
        * { box-sizing: border-box; }
        body { 
            font-family: "Microsoft JhengHei", "Noto Sans TC", sans-serif; 
            background-color: var(--bg-dark); 
            color: var(--text-main); 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden;
        }

        /* --- å´é‚Šå°èˆªæ¬„ --- */
        .sidebar {
            width: 260px;
            background-color: #202021;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            overflow: hidden;
            transition: transform 0.3s ease; /* å¢åŠ æ»‘å‹•å‹•ç•« */
            z-index: 100;
        }
        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid var(--border);
            font-size: 18px;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(45deg, #2563eb, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            flex-shrink: 0;
        }
        .nav-scroll {
            overflow-y: auto;
            flex: 1;
            padding-bottom: 20px;
        }
        .nav-scroll::-webkit-scrollbar { width: 6px; }
        .nav-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }
        
        .nav-group-title {
            padding: 15px 20px 5px;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
        }
        .nav-item {
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            color: #bbb;
            font-size: 14px;
            display: flex;
            align-items: center;
        }
        .nav-item:hover {
            background-color: var(--bg-hover);
            color: #fff;
        }
        .nav-item.active {
            background-color: rgba(59, 130, 246, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
            font-weight: bold;
        }

        /* --- æ‰‹æ©Ÿç‰ˆé¸å–®æŒ‰éˆ•èˆ‡é®ç½© --- */
        .mobile-toggle-btn {
            display: none; /* é›»è…¦ç‰ˆéš±è— */
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 101;
            background: var(--primary);
            border: none;
            color: white;
            font-size: 20px;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 90;
            backdrop-filter: blur(2px);
        }

        /* --- ä¸»è¦å…§å®¹å€ --- */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            position: relative;
        }
        .view-section {
            display: none;
            animation: fadeIn 0.3s ease;
            max-width: 1300px;
            margin: 0 auto;
        }
        .view-section.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- æ‰‹æ©Ÿç‰ˆ RWD è¨­å®š --- */
        @media (max-width: 768px) {
            .mobile-toggle-btn { display: block; } /* é¡¯ç¤ºæŒ‰éˆ• */
            
            .sidebar {
                position: fixed;
                height: 100%;
                left: 0;
                top: 0;
                transform: translateX(-100%); /* é è¨­éš±è— */
                box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            }
            .sidebar.active {
                transform: translateX(0); /* æ»‘å‡ºé¡¯ç¤º */
            }
            .overlay.active { display: block; }

            .main-content {
                width: 100%;
                padding-top: 70px; /* ç•™å‡ºé ‚éƒ¨æŒ‰éˆ•ç©ºé–“ */
            }

            /* è¡¨æ ¼èˆ‡ç‰ˆé¢èª¿æ•´ */
            .dashboard-panel { padding: 15px; min-height: auto; }
            h2 { font-size: 20px; }
            .controls { flex-direction: column; align-items: stretch; }
            .controls input, .controls select, .controls button { width: 100%; margin-bottom: 5px; }
            .pagination { justify-content: center; }
            
            /* å°‡é›™æ¬„ä½ˆå±€æ”¹ç‚ºå–®æ¬„ */
            div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
            div[style*="display:grid"] {
                grid-template-columns: 1fr !important;
            }
            
            /* è¡¨æ ¼æ–‡å­—ç¸®å° */
            table { font-size: 13px; }
            th, td { padding: 8px 5px; }
        }

        /* --- é€šç”¨å…ƒä»¶ --- */
        .dashboard-panel {
            background: var(--bg-panel);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            min-height: 400px;
        }
        h2 { text-align: center; margin-top: 0; margin-bottom: 20px; color: #fff; font-size: 24px; }
        
        .controls { 
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; 
            background: var(--bg-hover); padding: 15px; border-radius: 10px; margin-bottom: 20px; gap: 10px;
        }
        
        button { 
            padding: 8px 16px; border-radius: 6px; border: 1px solid #555; background: #333; 
            color: white; cursor: pointer; font-weight: bold; transition: 0.2s; 
        }
        button:hover { background: var(--primary); border-color: var(--primary); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        select, input {
            padding: 8px 12px; border-radius: 5px; border: 1px solid #555; background: #252526; 
            color: white; font-size: 14px;
        }

        .table-wrapper { overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; max-height: 70vh; }
        table { border-collapse: collapse; width: 100%; font-size: 14px; background: #252526; white-space: nowrap; }
        th, td { border-bottom: 1px solid var(--border); padding: 12px 15px; text-align: left; vertical-align: middle; }
        th { color: white; position: sticky; top: 0; z-index: 10; user-select: none; }
        
        /* è¡¨é ­é¡è‰²ä¸»é¡Œ */
        .th-red { background-color: #d62828; }
        .th-blue { background-color: #2563eb; }
        .th-green { background-color: #059669; }
        .th-orange { background-color: #f97316; }
        .th-purple { background-color: #7c3aed; }
        .th-pink { background-color: #db2777; }
        .th-cyan { background-color: #0891b2; }
        .th-gray { background-color: #4b5563; }

        tr:nth-child(even) { background-color: #262627; }
        tr:hover { background-color: var(--bg-hover); }

        /* ç‰¹æ®Šæ¨£å¼ */
        .stock-code { color: var(--accent); font-weight: bold; font-family: 'Consolas', monospace; text-align: center; }
        .val-up { color: var(--danger); font-weight: bold; }
        .val-down { color: var(--success); font-weight: bold; }
        .status-msg { text-align: center; font-size: 13px; color: var(--accent); margin: 10px 0; min-height: 20px; }
        .sort-icon { cursor: pointer; }
        .sort-icon::after { content: ' â†•'; opacity: 0.3; font-size: 0.8em; margin-left: 5px; }
        .sort-asc::after { content: ' â†‘'; opacity: 1; color: var(--accent); }
        .sort-desc::after { content: ' â†“'; opacity: 1; color: var(--accent); }
        .pagination { display: flex; align-items: center; gap: 10px; }
        .page-info { font-size: 14px; color: var(--primary); font-weight: bold; }

        /* é‡è¨Šå±•é–‹åˆ— */
        .detail-row { display: none; background-color: #202021; }
        .detail-content { padding: 20px; color: #ccc; line-height: 1.6; white-space: pre-wrap; border-left: 3px solid var(--primary); margin: 10px; }

        /* æ€§åˆ¥æ¯”ä¾‹æ¢ */
        .ratio-bar-container { width: 100px; background: #444; height: 8px; border-radius: 4px; overflow: hidden; display: flex; }
        .male-part { background: #3b82f6; height: 100%; }
        .female-part { background: #f472b6; height: 100%; }

        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: #3d3d3f; padding: 15px; border-radius: 10px; text-align: center; border-left: 4px solid var(--primary); }
        .stat-val { font-size: 20px; font-weight: bold; color: #fff; margin-top: 5px; }
        .stat-label { font-size: 12px; color: #aaa; }

        /* å½ˆçª— */
        .modal { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: var(--bg-panel); margin: 5% auto; padding: 25px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; border-radius: 15px; border: 1px solid var(--border); }
        .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .modal-item { border-bottom: 1px solid #444; padding: 8px 0; font-size: 14px; }
        .modal-label { color: var(--primary); font-weight: bold; margin-right: 10px; }

        /* æ’å */
        .rank-badge { font-weight: 900; font-style: italic; color: #666; width: 30px; display: inline-block; text-align: center; }
        .top-3 { color: var(--accent); font-size: 1.2em; text-shadow: 0 0 5px rgba(245, 158, 11, 0.3); }
        
        /* IPO æ¨™ç±¤ */
        .status-tag { padding: 2px 8px; border-radius: 4px; font-size: 11px; background: #444; color: #ccc; display: inline-block; margin-top: 4px; }
        .listed { background: #065f46; color: #a7f3d0; }
    </style>
</head>
<body>

<!-- æ‰‹æ©Ÿç‰ˆé¸å–®åˆ‡æ›æŒ‰éˆ• -->
<button class="mobile-toggle-btn" onclick="toggleSidebar()">â˜° é¸å–®</button>
<div class="overlay" onclick="toggleSidebar()"></div>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">ğŸ“Š å°è‚¡å…¨æ–¹ä½å„€è¡¨æ¿</div>
    <div class="nav-scroll">
        <div class="nav-group-title">å¸‚å ´æ¦‚æ³</div>
        <div class="nav-item active" onclick="switchView('view-attention')">ğŸš¨ æ³¨æ„è‚¡ç¥¨</div>
        <div class="nav-item" onclick="switchView('view-punish')">ğŸš§ è™•ç½®è‚¡ç¥¨</div>
        <div class="nav-item" onclick="switchView('view-top20')">ğŸ”¥ æˆäº¤é‡ TOP20</div>
        <div class="nav-item" onclick="switchView('view-news')">ğŸ“¢ é‡å¤§è¨Šæ¯</div>
        <div class="nav-item" onclick="switchView('view-ipo')">ğŸš€ æ–°è‚¡ä¸Šå¸‚é€²åº¦</div>
        <div class="nav-item" onclick="switchView('view-etrade')">ğŸ’» é›»å­äº¤æ˜“çµ±è¨ˆ</div>
        <div class="nav-item" onclick="switchView('view-holiday')">ğŸ—“ï¸ ä¼‘å¸‚è¡Œäº‹æ›†</div>
        
        <div class="nav-group-title">å€‹è‚¡èˆ‡åŸºæœ¬é¢</div>
        <div class="nav-item" onclick="switchView('view-revenue')">ğŸ’° ç‡Ÿæ”¶ç›£æ¸¬</div>
        <div class="nav-item" onclick="switchView('view-pepb')">ğŸ“ˆ æœ¬ç›Šæ¯”/æ®–åˆ©ç‡</div>
        <div class="nav-item" onclick="switchView('view-ranking')">ğŸ† å®šæœŸå®šé¡æ’è¡Œ</div>
        
        <div class="nav-group-title">ç±Œç¢¼èˆ‡è‚¡æ¬Š</div>
        <div class="nav-item" onclick="switchView('view-shareholders')">ğŸ¢ å¤§è‚¡æ±æŒè‚¡</div>
        <div class="nav-item" onclick="switchView('view-directors-all')">ğŸ›¡ï¸ è‘£ç›£æŒè‚¡åˆè¦</div>
        <div class="nav-item" onclick="switchView('view-directors-3m')">âš ï¸ è‘£ç›£ä¸è¶³(3æœˆ)</div>
        
        <div class="nav-group-title">è­‰åˆ¸å•†å°ˆå€</div>
        <div class="nav-item" onclick="switchView('view-broker-branch')">ğŸ“ æ“šé»èˆ‡é›»è©±æŸ¥è©¢</div>
        <div class="nav-item" onclick="switchView('view-broker-info')">ğŸ“’ åˆ¸å•†è²¡å‹™è³‡æ–™</div>
        <div class="nav-item" onclick="switchView('view-broker-dca')">ğŸ¦ å®šæœŸå®šé¡åˆ¸å•†</div>
        <div class="nav-item" onclick="switchView('view-personnel')">ğŸ‘¥ å¾æ¥­è·ä½çµ±è¨ˆ</div>
        <div class="nav-item" onclick="switchView('view-broker-gender')">ğŸš» ç‡Ÿæ¥­å“¡æ€§åˆ¥æ¯”</div>
    </div>
</div>

<div class="main-content">

    <!-- 1. æ³¨æ„è‚¡ç¥¨ -->
    <div id="view-attention" class="view-section active">
        <div class="dashboard-panel">
            <h2>ğŸš¨ è¿‘ 5 æ—¥æ³¨æ„è‚¡ç¥¨</h2>
            <div class="controls">
                <button onclick="Modules.Attention.init(true)">ğŸ”„ æ›´æ–°</button>
                <span id="att-range" style="color:#aaa; font-size:12px"></span>
            </div>
            <div id="att-status" class="status-msg"></div>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th class="th-red">æ—¥æœŸ</th><th class="th-red">ä»£è™Ÿ</th><th class="th-red">åç¨±</th><th class="th-red">æ¬¡æ•¸</th><th class="th-red">åŸå› </th></tr></thead>
                    <tbody id="att-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 2. è™•ç½®è‚¡ç¥¨ -->
    <div id="view-punish" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸš§ ä¸Šå¸‚è™•ç½®è‚¡ç¥¨å…¬å‘Š</h2>
            <div class="controls">
                <div class="pagination">
                    <button onclick="Modules.Punish.changePage(-1)">ä¸Šä¸€é </button>
                    <span id="punish-page" class="page-info">1 / 1</span>
                    <button onclick="Modules.Punish.changePage(1)">ä¸‹ä¸€é </button>
                </div>
                <button onclick="Modules.Punish.init(true)">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div id="punish-status" class="status-msg"></div>
            <div class="table-wrapper">
                <table>
                    <thead><tr>
                        <th class="th-orange sort-icon" onclick="Modules.Punish.sort('Code')">ä»£è™Ÿ</th>
                        <th class="th-orange">åç¨±</th>
                        <th class="th-orange sort-icon" onclick="Modules.Punish.sort('Date')">å…¬å‘Šæ—¥</th>
                        <th class="th-orange">è™•ç½®æœŸé–“</th>
                        <th class="th-orange">è™•ç½®æªæ–½</th>
                    </tr></thead>
                    <tbody id="punish-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. Top 20 (ä¿®æ­£ç‰ˆ) -->
    <div id="view-top20" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸ”¥ ä»Šæ—¥æˆäº¤é‡ TOP 20</h2>
            <div class="controls">
                <button onclick="Modules.Top20.init(true)">ğŸ”„ åˆ·æ–°æ¦œå–®</button>
                <span id="top20-date" style="color:#aaa"></span>
            </div>
            <div id="top20-status" class="status-msg"></div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th class="th-red sort-icon" onclick="Modules.Top20.sort('Rank')">æ’å</th>
                            <th class="th-red">ä»£è™Ÿ</th>
                            <th class="th-red">åç¨±</th>
                            <th class="th-red sort-icon" onclick="Modules.Top20.sort('TradeVolume')">æˆäº¤é‡(å¼µ)</th>
                            <th class="th-red sort-icon" onclick="Modules.Top20.sort('ClosingPrice')">æ”¶ç›¤åƒ¹</th>
                            <th class="th-red sort-icon" onclick="Modules.Top20.sort('Change')">æ¼²è·Œ</th>
                            <th class="th-red">æˆäº¤ç­†æ•¸</th>
                        </tr>
                    </thead>
                    <tbody id="top20-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 4. é‡å¤§è¨Šæ¯ -->
    <div id="view-news" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸ“¢ ä¸Šå¸‚å…¬å¸é‡å¤§è¨Šæ¯</h2>
            <div class="controls">
                <div class="pagination"><button onclick="Modules.News.changePage(-1)">â—€</button><span id="news-page" class="page-info">1</span><button onclick="Modules.News.changePage(1)">â–¶</button></div>
                <button onclick="Modules.News.init(true)">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div id="news-status" class="status-msg"></div>
            <div class="table-wrapper">
                <table>
                    <thead><tr><th class="th-blue">ä»£è™Ÿ</th><th class="th-blue">åç¨±</th><th class="th-blue">æ—¥æœŸ</th><th class="th-blue">æ™‚é–“</th><th class="th-blue">ä¸»æ—¨ (é»æ“Šå±•é–‹)</th></tr></thead>
                    <tbody id="news-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 5. æ–°è‚¡ä¸Šå¸‚ (ä¿®æ­£ç‰ˆ) -->
    <div id="view-ipo" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸš€ æ–°è‚¡ä¸Šå¸‚ç”³è«‹é€²åº¦</h2>
            <div class="controls">
                <div class="pagination">
                    <button onclick="Modules.IPO.changePage(-1)">â—€</button>
                    <span id="ipo-page" class="page-info">1</span>
                    <button onclick="Modules.IPO.changePage(1)">â–¶</button>
                </div>
                <button onclick="Modules.IPO.init(true)">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div id="ipo-status" class="status-msg"></div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th class="th-green sort-icon" onclick="Modules.IPO.sort('Code')">ä»£è™Ÿ</th>
                            <th class="th-green sort-icon" onclick="Modules.IPO.sort('Company')">å…¬å¸åç¨±</th>
                            <th class="th-green sort-icon" onclick="Modules.IPO.sort('ApplicationDate')">ç”³è«‹æ—¥æœŸ</th>
                            <th class="th-green sort-icon" onclick="Modules.IPO.sort('Chairman')">è‘£äº‹é•·</th>
                            <th class="th-green sort-icon" onclick="Modules.IPO.sort('_capitalNum')">å¯¦æ”¶è³‡æœ¬é¡</th>
                            <th class="th-green sort-icon" onclick="Modules.IPO.sort('_priceNum')">æ‰¿éŠ·åƒ¹</th>
                            <th class="th-green sort-icon" onclick="Modules.IPO.sort('ListingDate')">æ›ç‰Œæ—¥æœŸ</th>
                            <th class="th-green">ä¸»è¾¦æ‰¿éŠ·å•†</th>
                        </tr>
                    </thead>
                    <tbody id="ipo-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 6. é›»å­äº¤æ˜“ -->
    <div id="view-etrade" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸ’» é›»å­å¼äº¤æ˜“çµ±è¨ˆè¶¨å‹¢</h2>
            <div class="controls"><button onclick="Modules.ETrade.init(true)">ğŸ”„ åˆ·æ–°</button></div>
            <div class="stats-grid" id="etrade-stats"></div>
            <div class="table-wrapper" style="max-height:400px">
                <table>
                    <thead><tr><th class="th-blue">æœˆä»½</th><th class="th-blue">æ–°å¢æˆ¶æ•¸</th><th class="th-blue">ç´¯è¨ˆé–‹æˆ¶</th><th class="th-blue">äº¤æ˜“äººæ•¸</th><th class="th-blue">é‡‘é¡(å„„)</th><th class="th-blue">é›»å­ä½”æ¯”(é‡‘é¡)</th></tr></thead>
                    <tbody id="etrade-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 7. ä¼‘å¸‚è¡Œäº‹æ›† -->
    <div id="view-holiday" class="view-section">
        <div class="dashboard-panel" style="max-width:800px; margin:auto">
            <h2>ğŸ—“ï¸ å¸‚å ´ä¼‘å¸‚è¡Œäº‹æ›†</h2>
            <div class="controls"><button onclick="Modules.Holiday.init(true)">ğŸ”„ åˆ·æ–°</button></div>
            <div class="table-wrapper" style="max-height:500px">
                <table><thead><tr><th class="th-gray">æ—¥æœŸ</th><th class="th-gray">æ˜ŸæœŸ</th><th class="th-gray">åç¨±</th><th class="th-gray">èªªæ˜</th></tr></thead><tbody id="holiday-body"></tbody></table>
            </div>
        </div>
    </div>

    <!-- 8. ç‡Ÿæ”¶ (æ–°ç‰ˆ) -->
    <div id="view-revenue" class="view-section">
        <div class="dashboard-panel" style="max-width:700px; margin:auto; text-align:center">
            <h2>ğŸ’° å°è‚¡æœ€æ–°ç‡Ÿæ”¶ç›£æ¸¬</h2>
            <div class="controls" style="justify-content:center">
                <input type="text" id="rev-input" placeholder="è¼¸å…¥ä»£è™Ÿ (å¦‚ 2330)" style="text-align:center" onkeydown="if(event.keyCode==13) Modules.Revenue.query()">
                <button id="rev-btn" onclick="Modules.Revenue.query()">ğŸ” æŸ¥è©¢æœ€æ–°æ•¸æ“š</button>
            </div>
            <div id="rev-status" class="status-msg">è«‹è¼¸å…¥ä»£è™Ÿå¾ŒæŸ¥è©¢</div>
            
            <div id="rev-result" style="display:none; text-align:left; margin-top:20px; border-top:1px solid #444; padding-top:20px;">
                <div style="text-align:center">
                    <h3 id="rev-title" style="color:white; margin:0 0 5px 0"></h3>
                    <span id="rev-period" style="color:var(--primary); font-weight:bold; font-size:16px;"></span>
                </div>
                
                <div class="stats-grid" style="grid-template-columns:1fr 1fr; margin-top:20px;">
                    <div class="stat-card">
                        <div class="stat-label">æœ¬æœˆç‡Ÿæ¥­æ”¶å…¥</div>
                        <div id="rev-m" class="stat-val"></div>
                        <div id="rev-my" style="font-weight:bold; margin-top:5px"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">æœ¬å¹´ç´¯è¨ˆç‡Ÿæ”¶</div>
                        <div id="rev-c" class="stat-val"></div>
                        <div id="rev-cy" style="font-weight:bold; margin-top:5px"></div>
                    </div>
                </div>
                
                <div style="background:#332b00; padding:15px; border-radius:5px; border-left:5px solid #fcc419; margin-top:20px;">
                    <strong style="color:#fcc419">ğŸ“Š ç‡Ÿæ”¶è®ŠåŒ–åŸå› èªªæ˜ï¼š</strong><br>
                    <span id="rev-note" style="color:#e0e0e0; font-size:14px; line-height:1.5"></span>
                </div>
                
                <p id="rev-update" style="font-size:11px; color:#777; text-align:right; margin-top:15px"></p>
            </div>
        </div>
    </div>

    <!-- 9. æœ¬ç›Šæ¯” -->
    <div id="view-pepb" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸ“ˆ å€‹è‚¡æœ¬ç›Šæ¯” / æ®–åˆ©ç‡</h2>
            <div class="controls">
                <div class="pagination"><button onclick="Modules.PEPB.changePage(-1)">â—€</button><span id="pepb-page" class="page-info"></span><button onclick="Modules.PEPB.changePage(1)">â–¶</button></div>
                <input type="text" id="pepb-search" placeholder="æœå°‹ä»£è™Ÿ..." oninput="Modules.PEPB.search()">
            </div>
            <div class="table-wrapper">
                <table><thead><tr><th class="th-blue">ä»£è™Ÿ</th><th class="th-blue">åç¨±</th><th class="th-blue">æœ¬ç›Šæ¯”</th><th class="th-blue">æ®–åˆ©ç‡(%)</th><th class="th-blue">è‚¡åƒ¹æ·¨å€¼æ¯”</th></tr></thead><tbody id="pepb-body"></tbody></table>
            </div>
        </div>
    </div>

    <!-- 10. å®šæœŸå®šé¡ -->
    <div id="view-ranking" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸ† å®šæœŸå®šé¡æ’è¡Œ</h2>
            <div class="controls"><button onclick="Modules.Ranking.init(true)">ğŸ”„ åˆ·æ–°</button></div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px">
                <div class="table-wrapper"><table><thead><tr><th class="th-blue">åæ¬¡</th><th class="th-blue">è‚¡ç¥¨</th><th class="th-blue">æˆ¶æ•¸</th></tr></thead><tbody id="rank-stock"></tbody></table></div>
                <div class="table-wrapper"><table><thead><tr><th class="th-green">åæ¬¡</th><th class="th-green">ETF</th><th class="th-green">æˆ¶æ•¸</th></tr></thead><tbody id="rank-etf"></tbody></table></div>
            </div>
        </div>
    </div>

    <!-- 11. å¤§è‚¡æ± -->
    <div id="view-shareholders" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸ¢ å¤§è‚¡æ±æŒè‚¡ (>10%)</h2>
            <div class="controls">
                <div class="pagination"><button onclick="Modules.Holder.changePage(-1)">â—€</button><span id="holder-page" class="page-info"></span><button onclick="Modules.Holder.changePage(1)">â–¶</button></div>
                <input type="text" oninput="Modules.Holder.search(this.value)" placeholder="æœå°‹ä»£è™Ÿ...">
            </div>
            <div class="table-wrapper"><table><thead><tr><th class="th-purple">ä»£è™Ÿ</th><th class="th-purple">åç¨±</th><th class="th-purple">å¤§è‚¡æ±</th><th class="th-purple">æ—¥æœŸ</th></tr></thead><tbody id="holder-body"></tbody></table></div>
        </div>
    </div>

    <!-- 12. è‘£ç›£åˆè¦ -->
    <div id="view-directors-all" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸ›¡ï¸ è‘£ç›£æŒè‚¡åˆè¦ç¸½è¡¨</h2>
            <div class="controls">
                <div class="pagination"><button onclick="Modules.DirAll.changePage(-1)">â—€</button><span id="dirall-page" class="page-info"></span><button onclick="Modules.DirAll.changePage(1)">â–¶</button></div>
                <button onclick="Modules.DirAll.init(true)">ğŸ”„</button>
            </div>
            <div class="table-wrapper"><table><thead><tr><th class="th-orange">ä»£è™Ÿ</th><th class="th-orange">åç¨±</th><th class="th-orange">è‘£äº‹ç¼ºé¡</th><th class="th-orange">ç›£å¯Ÿç¼ºé¡</th></tr></thead><tbody id="dirall-body"></tbody></table></div>
        </div>
    </div>
    
    <!-- 13. è‘£ç›£ä¸è¶³ -->
    <div id="view-directors-3m" class="view-section">
        <div class="dashboard-panel">
            <h2>âš ï¸ è‘£ç›£ä¸è¶³æ³•å®šæˆæ•¸ (>3å€‹æœˆ)</h2>
            <div class="controls"><button onclick="Modules.Dir3m.init(true)">ğŸ”„ åˆ·æ–°</button></div>
            <div class="table-wrapper"><table><thead><tr><th class="th-red">ç‹€æ…‹</th><th class="th-red">å…¬å¸åå–®</th></tr></thead><tbody id="dir3m-body"></tbody></table></div>
        </div>
    </div>

    <!-- 14. æ“šé»æŸ¥è©¢ -->
    <div id="view-broker-branch" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸ“ è­‰åˆ¸å•†æ“šé»èˆ‡é›»è©±æŸ¥è©¢</h2>
            <div class="controls">
                <div class="pagination"><button onclick="Modules.BrBranch.changePage(-1)">â—€</button><span id="brbr-page" class="page-info"></span><button onclick="Modules.BrBranch.changePage(1)">â–¶</button></div>
                <input type="text" id="brbr-search" placeholder="æœå°‹åˆ¸å•†ã€åœ°å€(å¦‚æ¿æ©‹)..." oninput="Modules.BrBranch.search()">
            </div>
            <div class="table-wrapper">
                <table><thead><tr><th class="th-green">ä»£è™Ÿ</th><th class="th-green">åç¨±</th><th class="th-green">é›»è©±</th><th class="th-green">åœ°å€</th></tr></thead><tbody id="brbr-body"></tbody></table>
            </div>
        </div>
    </div>

    <!-- 15. åˆ¸å•†è²¡å‹™ -->
    <div id="view-broker-info" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸ“’ è­‰åˆ¸å•†åŸºæœ¬è²¡å‹™è³‡æ–™</h2>
            <div class="controls">
                <div class="pagination"><button onclick="Modules.BrInfo.changePage(-1)">â—€</button><span id="brinfo-page" class="page-info"></span><button onclick="Modules.BrInfo.changePage(1)">â–¶</button></div>
                <input type="text" oninput="Modules.BrInfo.search(this.value)" placeholder="æœå°‹...">
            </div>
            <div class="table-wrapper">
                <table><thead><tr><th class="th-blue">ä»£è™Ÿ</th><th class="th-blue">ç°¡ç¨±</th><th class="th-blue">è² è²¬äºº</th><th class="th-blue">è³‡æœ¬é¡(åƒ)</th><th class="th-blue">è©³æƒ…</th></tr></thead><tbody id="brinfo-body"></tbody></table>
            </div>
        </div>
    </div>

    <!-- 16. å®šæœŸå®šé¡åˆ¸å•† -->
    <div id="view-broker-dca" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸ¦ é–‹è¾¦å®šæœŸå®šé¡æ¥­å‹™åˆ¸å•†</h2>
            <div class="controls">
                <input type="text" oninput="Modules.BrDCA.search(this.value)" placeholder="æœå°‹åˆ¸å•†...">
                <button onclick="Modules.BrDCA.init(true)">ğŸ”„ åˆ·æ–°</button>
            </div>
            <div class="table-wrapper">
                <table><thead><tr><th class="th-cyan">ä»£è™Ÿ</th><th class="th-cyan">åˆ¸å•†åç¨±</th><th class="th-cyan">ç¶“ç´€é–‹è¾¦æ—¥</th><th class="th-cyan">è²¡ç®¡é–‹è¾¦æ—¥</th></tr></thead><tbody id="brdca-body"></tbody></table>
            </div>
        </div>
    </div>

    <!-- 17. è·ä½çµ±è¨ˆ -->
    <div id="view-personnel" class="view-section">
        <div class="dashboard-panel" style="max-width:800px; margin:auto">
            <h2>ğŸ‘¥ è­‰åˆ¸å•†å¾æ¥­äººå“¡è·ä½çµ±è¨ˆ</h2>
            <div class="controls"><button onclick="Modules.Personnel.init(true)">ğŸ”„ åˆ·æ–°</button></div>
            <div class="table-wrapper"><table><thead><tr><th class="th-purple">è·ä½</th><th class="th-purple">äººæ•¸</th><th class="th-purple">ä½”æ¯”</th></tr></thead><tbody id="personnel-body"></tbody></table></div>
        </div>
    </div>

    <!-- 18. æ€§åˆ¥æ¯”ä¾‹ -->
    <div id="view-broker-gender" class="view-section">
        <div class="dashboard-panel">
            <h2>ğŸš» ç‡Ÿæ¥­å“¡æ€§åˆ¥æ¯”ä¾‹çµ±è¨ˆ</h2>
            <div class="controls">
                <div class="pagination"><button onclick="Modules.BrGender.changePage(-1)">â—€</button><span id="gender-page" class="page-info"></span><button onclick="Modules.BrGender.changePage(1)">â–¶</button></div>
                <input type="text" oninput="Modules.BrGender.search(this.value)" placeholder="æœå°‹ä»£è™Ÿ...">
            </div>
            <div class="table-wrapper">
                <table><thead><tr><th class="th-pink">ä»£è™Ÿ</th><th class="th-pink">ç”·æ€§</th><th class="th-pink">å¥³æ€§</th><th class="th-pink">æ¯”ä¾‹åœ– (ç”·/å¥³)</th></tr></thead><tbody id="gender-body"></tbody></table>
            </div>
        </div>
    </div>

</div>

<!-- è©³æƒ…å½ˆçª— -->
<div id="detailModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle" style="color:var(--primary); border-bottom:1px solid #555; padding-bottom:10px"></h3>
        <div id="modalBody" class="modal-grid"></div>
        <div style="text-align:right; margin-top:20px"><button onclick="document.getElementById('detailModal').style.display='none'" style="background:var(--danger)">é—œé–‰</button></div>
    </div>
</div>

<script>
    const Utils = {
        cors: (u) => "https://corsproxy.io/?" + encodeURIComponent(u),
        fmtNum: (n) => n ? parseInt(n).toLocaleString() : '0',
        cleanNum: (v) => parseFloat((v||"0").toString().replace(/,/g,'')) || 0,
        fmtDate: (d) => { const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}${m}${dd}`; }
    };

    // --- å´é‚Šæ¬„åˆ‡æ›é‚è¼¯ (æ‰‹æ©Ÿç‰ˆ) ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.querySelector('.overlay');
        const isActive = sidebar.classList.contains('active');
        
        if (isActive) {
            sidebar.classList.remove('active');
            overlay.classList.remove('active');
        } else {
            sidebar.classList.add('active');
            overlay.classList.add('active');
        }
    }

    function switchView(id) {
        document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
        
        // å¦‚æœæ˜¯æ‰‹æ©Ÿç‰ˆï¼Œåˆ‡æ›åŠŸèƒ½å¾Œè‡ªå‹•æ”¶èµ·å´é‚Šæ¬„
        if (window.innerWidth <= 768) {
            toggleSidebar();
        }
        
        const mod = {
            'view-attention': Modules.Attention, 'view-punish': Modules.Punish, 'view-top20': Modules.Top20,
            'view-news': Modules.News, 'view-ipo': Modules.IPO, 'view-etrade': Modules.ETrade,
            'view-holiday': Modules.Holiday, 'view-pepb': Modules.PEPB, 'view-ranking': Modules.Ranking,
            'view-shareholders': Modules.Holder, 'view-directors-all': Modules.DirAll, 'view-directors-3m': Modules.Dir3m,
            'view-broker-branch': Modules.BrBranch, 'view-broker-info': Modules.BrInfo, 'view-broker-dca': Modules.BrDCA,
            'view-personnel': Modules.Personnel, 'view-broker-gender': Modules.BrGender
        }[id];
        if(mod && !mod.loaded) mod.init();
    }

    const Modules = {
        // 1. æ³¨æ„è‚¡ç¥¨
        Attention: {
            loaded: false,
            init: async function(force) {
                if(this.loaded && !force) return;
                const tbody = document.getElementById('att-body');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">â³ è¼‰å…¥ä¸­...</td></tr>';
                const today = new Date(); const start = new Date(); start.setDate(today.getDate()-7);
                try {
                    const res = await fetch(Utils.cors(`https://www.twse.com.tw/rwd/zh/announcement/notice?startDate=${Utils.fmtDate(start)}&endDate=${Utils.fmtDate(today)}&response=json`));
                    const json = await res.json();
                    if(json.stat!=="OK") throw new Error();
                    tbody.innerHTML="";
                    const map={d:0, c:1, n:2, cnt:3, r:4}; 
                    if(json.fields) {
                        map.d = json.fields.findIndex(f=>f.includes("æ—¥æœŸ"));
                        map.c = json.fields.findIndex(f=>f.includes("ä»£è™Ÿ"));
                        map.n = json.fields.findIndex(f=>f.includes("åç¨±"));
                        map.cnt = json.fields.findIndex(f=>f.includes("æ¬¡æ•¸"));
                        map.r = json.fields.findIndex(f=>f.includes("è³‡è¨Š"));
                    }
                    [...json.data].reverse().forEach(row=>{
                        const reason = document.createElement('div'); reason.innerHTML = row[map.r];
                        tbody.innerHTML += `<tr><td>${row[map.d]}</td><td class="stock-code">${row[map.c]}</td><td>${row[map.n]}</td><td style="color:var(--accent)">${row[map.cnt]}</td><td style="font-size:12px;color:#aaa">${reason.textContent}</td></tr>`;
                    });
                    document.getElementById('att-range').innerText = `ç¯„åœ: ${Utils.fmtDate(start)} ~ ${Utils.fmtDate(today)}`;
                    this.loaded=true;
                } catch(e){ tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">æŸ¥ç„¡è³‡æ–™</td></tr>'; }
            }
        },
        // 2. è™•ç½®è‚¡ç¥¨
        Punish: {
            loaded: false, data: [], page: 1, size: 20,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/announcement/punish"));
                    this.data = await res.json();
                    this.loaded=true; this.sort('Date');
                } catch(e){}
            },
            render: function() {
                const tbody = document.getElementById('punish-body'); tbody.innerHTML="";
                const start=(this.page-1)*this.size;
                this.data.slice(start, start+this.size).forEach(i=>{
                   tbody.innerHTML+=`<tr><td class="stock-code">${i.Code}</td><td>${i.Name}</td><td>${i.Date}</td><td style="font-size:12px">${i.DispositionPeriod}</td><td style="font-size:12px;color:#fca5a5">${i.DispositionMeasures}</td></tr>`;
                });
                document.getElementById('punish-page').innerText = `${this.page}/${Math.ceil(this.data.length/this.size)}`;
            },
            changePage: function(d) { if(this.page+d>0 && this.page+d<=Math.ceil(this.data.length/this.size)) { this.page+=d; this.render(); } },
            sort: function(key) { 
                this.data.sort((a,b)=>(a[key]||"").localeCompare(b[key]||"") * -1); 
                this.page=1; this.render();
            }
        },
        // 3. Top 20 (ä¿®æ­£ç‰ˆ)
        Top20: {
            loaded: false, data: [], currentSort: { key: 'Rank', dir: 'asc' },
            init: async function(force) {
                if(this.loaded && !force) return;
                const tbody = document.getElementById('top20-body');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">â³ è¼‰å…¥ä¸­...</td></tr>';
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/exchangeReport/MI_INDEX20"));
                    const rawData = await res.json();
                    
                    // é è™•ç†è³‡æ–™ (è½‰æ•¸å€¼)
                    this.data = rawData.map((item, index) => ({
                        ...item,
                        Rank: parseInt(item.Rank) || (index + 1),
                        TradeVolume: parseInt(item.TradeVolume.replace(/,/g, '')),
                        ClosingPrice: parseFloat(item.ClosingPrice.replace(/,/g, '')),
                        Change: parseFloat(item.Change) * (item.Dir.includes('â–¼') || item.Dir.includes('-') ? -1 : 1),
                        Transaction: parseInt(item.Transaction.replace(/,/g, ''))
                    }));

                    document.getElementById('top20-date').innerText = `è³‡æ–™æ—¥æœŸ: ${rawData[0].Date}`;
                    this.loaded=true;
                    this.sort('Rank', 'asc'); // é è¨­ä¾æ’åæ’åº
                } catch(e){ 
                    console.error(e);
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--danger)">âŒ è¼‰å…¥å¤±æ•—</td></tr>';
                }
            },
            sort: function(key, forceDir = null) {
                if (forceDir) {
                    this.currentSort.dir = forceDir;
                } else {
                    // åˆ‡æ›æ’åº (æ’åé è¨­å‡åºï¼Œå…¶é¤˜é™åº)
                    if (this.currentSort.key === key) {
                        this.currentSort.dir = this.currentSort.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.currentSort.dir = key === 'Rank' ? 'asc' : 'desc';
                    }
                }
                this.currentSort.key = key;
                
                this.data.sort((a, b) => {
                    return this.currentSort.dir === 'asc' ? a[key] - b[key] : b[key] - a[key];
                });
                this.render();
            },
            render: function() {
                const tbody = document.getElementById('top20-body'); tbody.innerHTML="";
                this.data.forEach((i, idx)=>{
                    const volDisplay = Math.floor(i.TradeVolume / 1000).toLocaleString(); // æ›ç®—æˆå¼µ
                    const diffClass = i.Change > 0 ? 'val-up' : (i.Change < 0 ? 'val-down' : '');
                    
                    tbody.innerHTML += `
                        <tr>
                            <td><span class="rank-badge ${i.Rank<=3?'top-3':''}">${i.Rank}</span></td>
                            <td class="stock-code">${i.Code}</td>
                            <td style="font-weight:bold">${i.Name}</td>
                            <td style="color:var(--accent)">${volDisplay}</td>
                            <td style="font-weight:bold">${i.ClosingPrice.toFixed(2)}</td>
                            <td class="${diffClass}">${i.Dir}${Math.abs(i.Change).toFixed(2)}</td>
                            <td style="color:#aaa">${i.Transaction.toLocaleString()}</td>
                        </tr>`;
                });
            }
        },
        // 4. é‡å¤§è¨Šæ¯
        News: {
            loaded: false, data: [], page: 1, size: 20,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/opendata/t187ap04_L"));
                    this.data = await res.json();
                    this.loaded=true; this.render();
                } catch(e){}
            },
            render: function() {
                const tbody = document.getElementById('news-body'); tbody.innerHTML="";
                const list = this.data.slice((this.page-1)*this.size, this.page*this.size);
                list.forEach((i, idx)=>{
                    const uid = `news-${idx}`;
                    tbody.innerHTML += `<tr><td class="stock-code">${i.å…¬å¸ä»£è™Ÿ}</td><td>${i.å…¬å¸åç¨±}</td><td>${i.ç™¼è¨€æ—¥æœŸ}</td><td>${i.ç™¼è¨€æ™‚é–“}</td><td style="color:var(--primary);cursor:pointer" onclick="document.getElementById('${uid}').style.display=document.getElementById('${uid}').style.display==='block'?'none':'block'">${i.ä¸»æ—¨}</td></tr>
                    <tr><td colspan="5" style="padding:0;border:none"><div id="${uid}" class="detail-row"><div class="detail-content">${i.èªªæ˜}</div></div></td></tr>`;
                });
                document.getElementById('news-page').innerText = this.page;
            },
            changePage: function(d) { if(this.page+d>0) { this.page+=d; this.render(); } }
        },
        // 5. æ–°è‚¡ä¸Šå¸‚ (ä¿®æ­£ç‰ˆ)
        IPO: {
            loaded: false, data: [], page: 1, size: 20, currentSort: { key: 'ApplicationDate', dir: 'desc' },
            init: async function(force) {
                if(this.loaded && !force) return;
                const tbody = document.getElementById('ipo-body');
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center">â³ è¼‰å…¥ä¸­...</td></tr>';
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/company/newlisting"));
                    const rawData = await res.json();
                    
                    // é è™•ç†
                    this.data = rawData.map(item => {
                        const capStr = item["AmountofCapital "] || item["AmountofCapital"] || "0";
                        const priceStr = item["UnderwritingPrice"] || "0";
                        return {
                            ...item,
                            _capitalNum: parseInt(capStr.replace(/,/g, '')) || 0,
                            _priceNum: parseFloat(priceStr.replace(/,/g, '')) || 0,
                            _isListed: (item.ListingDate || "").trim() !== ""
                        };
                    });

                    this.loaded=true; 
                    this.sort('ApplicationDate', 'desc');
                } catch(e){
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--danger)">âŒ è¼‰å…¥å¤±æ•—</td></tr>';
                }
            },
            sort: function(key, forceDir = null) {
                if (forceDir) {
                    this.currentSort.dir = forceDir;
                } else {
                    this.currentSort.dir = (this.currentSort.key === key && this.currentSort.dir === 'asc') ? 'desc' : 'asc';
                }
                this.currentSort.key = key;

                this.data.sort((a, b) => {
                    let vA = a[key] || '';
                    let vB = b[key] || '';
                    if (this.currentSort.dir === 'asc') return vA > vB ? 1 : -1;
                    return vA < vB ? 1 : -1;
                });
                
                this.page = 1;
                this.render();
            },
            changePage: function(d) {
                const max = Math.ceil(this.data.length / this.size);
                if (this.page + d > 0 && this.page + d <= max) {
                    this.page += d;
                    this.render();
                }
            },
            render: function() {
                const tbody = document.getElementById('ipo-body'); tbody.innerHTML="";
                const start = (this.page - 1) * this.size;
                const end = start + this.size;
                const list = this.data.slice(start, end);
                const totalPages = Math.ceil(this.data.length / this.size);

                list.forEach(i=>{
                    const statusTag = i._isListed ? 
                        `<span class="status-tag listed">å·²æ›ç‰Œ</span>` : 
                        `<span class="status-tag">å¯©æ ¸ä¸­</span>`;
                    
                    const capDisplay = (i._capitalNum / 100000000).toFixed(2); // æ›ç®—æˆå„„

                    tbody.innerHTML += `
                        <tr>
                            <td class="stock-code">${i.Code||'-'}</td>
                            <td><div style="font-weight:bold;color:#64b5f6">${i.Company}</div>${statusTag}</td>
                            <td>${i.ApplicationDate}</td>
                            <td>${i.Chairman||'-'}</td>
                            <td style="color:var(--accent)">${capDisplay} å„„</td>
                            <td style="font-weight:bold">${i.UnderwritingPrice||'-'}</td>
                            <td style="color:var(--success);font-weight:bold">${i.ListingDate||'-'}</td>
                            <td style="font-size:11px;color:#aaa">${i.Underwriter||'-'}</td>
                        </tr>`;
                });
                
                document.getElementById('ipo-page').innerText = `${this.page} / ${totalPages}`;
            }
        },
        // 6. é›»å­äº¤æ˜“
        ETrade: {
            loaded: false,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/opendata/t187ap19"));
                    const data = await res.json(); data.reverse();
                    const last = data[0];
                    document.getElementById('etrade-stats').innerHTML = `
                        <div class="stat-card"><div class="stat-label">æœ€æ–°æœˆä»½</div><div class="stat-val">${last.æˆäº¤æœˆä»½}</div></div>
                        <div class="stat-card"><div class="stat-label">æœ¬æœˆæ–°å¢æˆ¶</div><div class="stat-val" style="color:var(--accent)">${last.æœ¬æœˆæ–°å¢æˆ¶æ•¸}</div></div>
                        <div class="stat-card"><div class="stat-label">é›»å­äº¤æ˜“ä½”æ¯”(é‡‘é¡)</div><div class="stat-val">${last["å å¸‚å ´æˆäº¤æ¯”ç‡(é‡‘é¡)"]}%</div></div>
                        <div class="stat-card"><div class="stat-label">å¹³å‡æ¯ç­†é‡‘é¡</div><div class="stat-val">${last.å¹³å‡æ¯ç­†æˆäº¤é‡‘é¡}</div></div>
                    `;
                    const tbody = document.getElementById('etrade-body'); tbody.innerHTML="";
                    data.forEach(i=>{
                         const amt = (parseFloat(i.æˆäº¤é‡‘é¡.replace(/,/g,''))/100000000).toFixed(1);
                         tbody.innerHTML+=`<tr><td>${i.æˆäº¤æœˆä»½}</td><td>${i.æœ¬æœˆæ–°å¢æˆ¶æ•¸}</td><td>${i.ç´¯è¨ˆé–‹æˆ¶æ•¸}</td><td>${i.æœ¬æœˆäº¤æ˜“äººæ•¸}</td><td style="color:var(--accent)">${amt}</td><td>${i["å å¸‚å ´æˆäº¤æ¯”ç‡(é‡‘é¡)"]}%</td></tr>`;
                    });
                    this.loaded=true;
                } catch(e){}
            }
        },
        // 7. ä¼‘å¸‚
        Holiday: {
            loaded: false,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/holidaySchedule/holidaySchedule"));
                    const data = await res.json();
                    const tbody = document.getElementById('holiday-body'); tbody.innerHTML="";
                    const now = new Date().toISOString().slice(0,10).replace(/-/g,'');
                    data.forEach(i=>{
                        const isPast = i.Date.replace(/\//g,'') < now;
                        tbody.innerHTML+=`<tr style="${isPast?'opacity:0.5':''}"><td style="color:${isPast?'#aaa':'var(--primary)'}">${i.Date}</td><td>${i.Weekday}</td><td>${i.Name}</td><td>${i.Description}</td></tr>`;
                    });
                    this.loaded=true;
                } catch(e){}
            }
        },
        // 8. ç‡Ÿæ”¶ (å…¨åŠŸèƒ½ç§»æ¤ç‰ˆ)
        Revenue: {
            query: async function() {
                const id = document.getElementById('rev-input').value.trim();
                const btn = document.getElementById('rev-btn');
                const status = document.getElementById('rev-status');
                
                if(!id) { alert('è«‹è¼¸å…¥å…¬å¸ä»£è™Ÿ'); return; }
                
                const originalText = btn.innerText;
                btn.innerText = "ğŸš€ é€£ç·šä¸­..."; btn.disabled = true;
                status.innerText = "â³ æ­£åœ¨æŸ¥è©¢å…¬é–‹è³‡è¨Šè§€æ¸¬ç«™...";
                
                // åŠ å…¥æ™‚é–“æˆ³è¨˜é¿å…å¿«å–
                const apiUrl = `https://mops.twse.com.tw/mops/api/t05st10_ifrs?t=${new Date().getTime()}`;

                try {
                    const res = await fetch(Utils.cors(apiUrl), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            companyId: id, 
                            dataType: "1", 
                            year: "", 
                            month: "", 
                            subsidiaryCompanyId: "" 
                        })
                    });
                    
                    const json = await res.json();
                    
                    if(json.code === 200 && json.result && json.result.data) {
                        const d = json.result.data;
                        const info = json.result;
                        
                        document.getElementById('rev-result').style.display = 'block';
                        document.getElementById('rev-title').innerText = `${info.companyAbbreviation} (${id})`;
                        
                        // è™•ç†æ—¥æœŸæ ¼å¼ (ex: 11301)
                        const yymm = info.yymm || "";
                        const y = yymm.substring(0,3);
                        const m = yymm.substring(3);
                        document.getElementById('rev-period').innerText = `è³‡æ–™æœŸåˆ¥ï¼šæ°‘åœ‹ ${y} å¹´ ${m} æœˆ`;
                        
                        // è¼”åŠ©å‡½å¼ï¼šè™•ç†æ•¸å€¼èˆ‡é¡è‰²
                        const setVal = (eid, val, isPct) => {
                            const el = document.getElementById(eid);
                            const num = parseFloat(val.replace(/,/g,''));
                            
                            if(isNaN(num)) {
                                el.innerText = "--"; el.className = "";
                            } else {
                                if(isPct) {
                                    el.innerText = `YoY ${val}% ${num>=0?'â–²':'â–¼'}`;
                                    el.className = num>=0 ? 'val-up' : 'val-down';
                                    el.style.color = num>=0 ? 'var(--danger)' : 'var(--success)';
                                } else {
                                    el.innerText = `$ ${val} ä»Ÿå…ƒ`;
                                    el.className = 'stat-val';
                                }
                            }
                        };

                        setVal('rev-m', d[0][1], false);
                        setVal('rev-my', d[3][1], true);
                        setVal('rev-c', d[4][1], false);
                        setVal('rev-cy', d[7][1], true);
                        
                        document.getElementById('rev-note').innerText = (d[8] && d[8][1]) ? d[8][1] : "è©²å…¬å¸ç„¡ç‰¹å®šç‡Ÿæ”¶åŸå› èªªæ˜ã€‚";
                        document.getElementById('rev-update').innerText = `API æŸ¥è©¢æ™‚é–“ï¼š${json.datetime}`;
                        status.innerText = "âœ… æŸ¥è©¢æˆåŠŸ";
                    } else {
                        document.getElementById('rev-result').style.display = 'none';
                        status.innerText = "âš ï¸ æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªä»£è™Ÿæ˜¯å¦æ­£ç¢º";
                    }
                } catch(e) { 
                    console.error(e);
                    status.innerText = "âŒ é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"; 
                    document.getElementById('rev-result').style.display = 'none';
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        },
        // 9. æœ¬ç›Šæ¯”
        PEPB: {
            loaded: false, data: [], filtered: [], page: 1, size: 50,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/exchangeReport/BWIBBU_ALL"));
                    this.data = await res.json();
                    this.filtered = this.data;
                    this.loaded=true; this.render();
                } catch(e){}
            },
            search: function() {
                const term = document.getElementById('pepb-search').value.toUpperCase();
                this.filtered = this.data.filter(i=>i.Code.includes(term)||i.Name.includes(term));
                this.page=1; this.render();
            },
            render: function() {
                const tbody = document.getElementById('pepb-body'); tbody.innerHTML="";
                const start=(this.page-1)*this.size;
                this.filtered.slice(start, start+this.size).forEach(i=>{
                    tbody.innerHTML+=`<tr><td class="stock-code">${i.Code}</td><td>${i.Name}</td><td>${i.PEratio}</td><td style="color:#66bb6a">${i.DividendYield}</td><td>${i.PBratio}</td></tr>`;
                });
                document.getElementById('pepb-page').innerText = `${this.page}/${Math.ceil(this.filtered.length/this.size)||1}`;
            },
            changePage: function(d) { if(this.page+d>0 && this.page+d<=Math.ceil(this.filtered.length/this.size)) { this.page+=d; this.render(); } }
        },
        // 10. å®šæœŸå®šé¡
        Ranking: {
            loaded: false,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/ETFReport/ETFRank"));
                    const data = await res.json();
                    const sB = document.getElementById('rank-stock'); const eB = document.getElementById('rank-etf');
                    sB.innerHTML=""; eB.innerHTML="";
                    data.forEach(i=>{
                        const hl = i.No<=3 ? 'color:var(--accent);font-weight:bold' : '';
                        if(i.STOCKsSecurityCode) sB.innerHTML+=`<tr><td style="${hl}">${i.No}</td><td class="stock-code">${i.STOCKsSecurityCode} ${i.STOCKsName}</td><td>${Utils.fmtNum(i.STOCKsNumberofTradingAccounts)}</td></tr>`;
                        if(i.ETFsSecurityCode) eB.innerHTML+=`<tr><td style="${hl}">${i.No}</td><td class="stock-code">${i.ETFsSecurityCode} ${i.ETFsName}</td><td>${Utils.fmtNum(i.ETFsNumberofTradingAccounts)}</td></tr>`;
                    });
                    this.loaded=true;
                } catch(e){}
            }
        },
        // 11. å¤§è‚¡æ±
        Holder: {
            loaded: false, data: [], filtered: [], page: 1, size: 50,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/opendata/t187ap02_L"));
                    this.data = await res.json(); this.filtered=this.data;
                    this.loaded=true; this.render();
                } catch(e){}
            },
            search: function(v) { this.filtered=this.data.filter(i=>i["å…¬å¸ä»£è™Ÿ"].includes(v)); this.page=1; this.render(); },
            render: function() {
                const tbody = document.getElementById('holder-body'); tbody.innerHTML="";
                this.filtered.slice((this.page-1)*this.size, this.page*this.size).forEach(i=>{
                    tbody.innerHTML+=`<tr><td class="stock-code">${i["å…¬å¸ä»£è™Ÿ"]}</td><td>${i["å…¬å¸åç¨±"]}</td><td style="color:var(--primary)">${i["å¤§è‚¡æ±åç¨±"]}</td><td>${i["å‡ºè¡¨æ—¥æœŸ"]}</td></tr>`;
                });
                document.getElementById('holder-page').innerText = this.page;
            },
            changePage: function(d) { if(this.page+d>0) { this.page+=d; this.render(); } }
        },
        // 12. è‘£ç›£åˆè¦
        DirAll: {
            loaded: false, data: [], page: 1, size: 50,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/opendata/t187ap08_L"));
                    this.data = await res.json();
                    this.data.sort((a,b)=>Utils.cleanNum(b["å…¨é«”è‘£äº‹ä¸è¶³è‚¡æ•¸"])-Utils.cleanNum(a["å…¨é«”è‘£äº‹ä¸è¶³è‚¡æ•¸"]));
                    this.loaded=true; this.render();
                } catch(e){}
            },
            render: function() {
                const tbody = document.getElementById('dirall-body'); tbody.innerHTML="";
                this.data.slice((this.page-1)*this.size, this.page*this.size).forEach(i=>{
                    const d = Utils.cleanNum(i["å…¨é«”è‘£äº‹ä¸è¶³è‚¡æ•¸"]);
                    const s = Utils.cleanNum(i["å…¨é«”ç›£å¯Ÿäººä¸è¶³è‚¡æ•¸"]);
                    tbody.innerHTML+=`<tr><td class="stock-code">${i["å…¬å¸ä»£è™Ÿ"]}</td><td>${i["å…¬å¸åç¨±"]}</td><td style="color:${d>0?'var(--danger)':'#aaa'}">${d>0?Utils.fmtNum(d):'OK'}</td><td style="color:${s>0?'var(--danger)':'#aaa'}">${s>0?Utils.fmtNum(s):'OK'}</td></tr>`;
                });
                document.getElementById('dirall-page').innerText = this.page;
            },
            changePage: function(d) { if(this.page+d>0) { this.page+=d; this.render(); } }
        },
        // 13. è‘£ç›£ä¸è¶³3M
        Dir3m: {
            loaded: false,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    // Fetch shortage list
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/opendata/t187ap10_L"));
                    const raw = await res.json(); 
                    const d = raw[0];

                    // Fetch Code-Name mapping (Stock list)
                    let stockMap = {};
                    try {
                        const resNames = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/exchangeReport/BWIBBU_ALL"));
                        const dataNames = await resNames.json();
                        dataNames.forEach(x => stockMap[x.Code] = x.Name);
                    } catch(e) { console.warn("Failed to load stock names"); }

                    const tbody = document.getElementById('dir3m-body'); 
                    tbody.innerHTML="";
                    const keys = [
                        {k:"é€£çºŒä¸è¶³é€¾1å¹´ä»¥ä¸Š",l:"é€¾1å¹´",c:"#ef4444"}, 
                        {k:"é€£çºŒä¸è¶³é”6å€‹æœˆ",l:"é”6æœˆ",c:"#f97316"}, 
                        {k:"é€£çºŒä¸è¶³é”3å€‹æœˆ",l:"é”3æœˆ",c:"#f97316"}
                    ];
                    
                    keys.forEach(k => {
                        let rawStr = d[k.k];
                        if(rawStr) {
                            // Extract codes (assuming codes are 4+ digits)
                            // The raw string usually looks like "2330, 2454"
                            let formatted = rawStr;
                            const codes = rawStr.match(/\d{4,}/g);
                            if(codes) {
                                const items = codes.map(c => {
                                    const name = stockMap[c] || "";
                                    return `<span class="stock-code">${c}</span> <span style="color:#ccc">${name}</span>`;
                                });
                                formatted = items.join("ã€");
                            }
                            tbody.innerHTML+=`<tr><td style="white-space:nowrap"><span style="border:1px solid ${k.c};color:${k.c};padding:2px 5px;border-radius:3px;font-size:12px">${k.l}</span></td><td>${formatted}</td></tr>`;
                        }
                    });
                    this.loaded=true;
                } catch(e){ console.error(e); }
            }
        },
        // 14. æ“šé»æŸ¥è©¢
        BrBranch: {
            loaded: false, data: [], filtered: [], page: 1, size: 20,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/opendata/OpenData_BRK02"));
                    this.data = await res.json();
                    this.filtered = this.data.filter(i=>i["è­‰åˆ¸å•†ä»£è™Ÿ"]!=="string");
                    this.loaded=true; this.render();
                } catch(e){}
            },
            search: function() {
                const v = document.getElementById('brbr-search').value.toLowerCase();
                this.filtered = this.data.filter(i=>i["è­‰åˆ¸å•†åç¨±"].includes(v)||i["åœ°å€"].includes(v));
                this.page=1; this.render();
            },
            render: function() {
                const tbody = document.getElementById('brbr-body'); tbody.innerHTML="";
                this.filtered.slice((this.page-1)*this.size, this.page*this.size).forEach(i=>{
                    tbody.innerHTML+=`<tr><td class="stock-code">${i["è­‰åˆ¸å•†ä»£è™Ÿ"]}</td><td>${i["è­‰åˆ¸å•†åç¨±"]}</td><td>${i["é›»è©±"]}</td><td style="font-size:12px;color:#aaa">${i["åœ°å€"]}</td></tr>`;
                });
                document.getElementById('brbr-page').innerText = `${this.page}/${Math.ceil(this.filtered.length/this.size)}`;
            },
            changePage: function(d) { if(this.page+d>0 && this.page+d<=Math.ceil(this.filtered.length/this.size)) { this.page+=d; this.render(); } }
        },
        // 15. åˆ¸å•†è²¡å‹™
        BrInfo: {
            loaded: false, data: [], filtered: [], page: 1, size: 20,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/opendata/t187ap18"));
                    this.data = await res.json();
                    this.filtered = this.data.filter(i=>i["è­‰åˆ¸ä»£è™Ÿ"]!=="string");
                    this.loaded=true; this.render();
                } catch(e){}
            },
            search: function(v) {
                this.filtered = this.data.filter(i=>i["åˆ¸å•†(è­‰åˆ¸IB)ç°¡ç¨±"].includes(v)||i["è­‰åˆ¸ä»£è™Ÿ"].includes(v));
                this.page=1; this.render();
            },
            render: function() {
                const tbody = document.getElementById('brinfo-body'); tbody.innerHTML="";
                this.filtered.slice((this.page-1)*this.size, this.page*this.size).forEach((i, idx)=>{
                    const cap = parseInt(i["å¯¦æ”¶è³‡æœ¬é¡ï¼ˆä»Ÿå…ƒï¼‰"]||0).toLocaleString();
                    tbody.innerHTML+=`<tr><td class="stock-code">${i["è­‰åˆ¸ä»£è™Ÿ"]}</td><td>${i["åˆ¸å•†(è­‰åˆ¸IB)ç°¡ç¨±"]}</td><td>${i["è² è²¬äºº"]}</td><td style="text-align:right;color:#a7f3d0">${cap}</td><td><button style="padding:2px 8px;font-size:12px" onclick="Modules.BrInfo.showDetail('${i["è­‰åˆ¸ä»£è™Ÿ"]}')">è©³ç´°</button></td></tr>`;
                });
                document.getElementById('brinfo-page').innerText = this.page;
            },
            showDetail: function(code) {
                const item = this.data.find(i=>i["è­‰åˆ¸ä»£è™Ÿ"]===code);
                const body = document.getElementById('modalBody'); body.innerHTML="";
                document.getElementById('modalTitle').innerText = item["åˆ¸å•†(è­‰åˆ¸IB)ç°¡ç¨±"];
                Object.keys(item).forEach(k=>{
                    if(item[k] && item[k]!=="string") body.innerHTML+=`<div class="modal-item"><span class="modal-label">${k}:</span> ${item[k]}</div>`;
                });
                document.getElementById('detailModal').style.display = 'block';
            },
            changePage: function(d) { if(this.page+d>0) { this.page+=d; this.render(); } }
        },
        // 16. å®šæœŸå®šé¡åˆ¸å•†
        BrDCA: {
            loaded: false, data: [], filtered: [],
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/brokerService/secRegData"));
                    this.data = await res.json(); this.filtered=this.data;
                    this.loaded=true; this.render();
                } catch(e){}
            },
            search: function(v) { this.filtered=this.data.filter(i=>i.Name.includes(v)); this.render(); },
            render: function() {
                const tbody = document.getElementById('brdca-body'); tbody.innerHTML="";
                this.filtered.forEach(i=>{
                    tbody.innerHTML+=`<tr><td class="stock-code">${i.SecuritiesFirmCode}</td><td>${i.Name}</td><td>${i.BrokerageBusinessStartingDate||'-'}</td><td>${i.WealthManagementBusinessStartingDate||'-'}</td></tr>`;
                });
            }
        },
        // 17. è·ä½
        Personnel: {
            loaded: false,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/opendata/t187ap01"));
                    const data = await res.json(); const rec=data[0];
                    const tbody = document.getElementById('personnel-body'); tbody.innerHTML="";
                    const skips=["å‡ºè¡¨æ—¥æœŸ","åˆè¨ˆ"];
                    Object.keys(rec).filter(k=>!skips.includes(k)&&!isNaN(parseInt(rec[k]))).map(k=>({n:k,c:parseInt(rec[k])})).sort((a,b)=>b.c-a.c).forEach(i=>{
                        tbody.innerHTML+=`<tr><td>${i.n}</td><td style="color:var(--accent)">${i.c.toLocaleString()}</td><td>${((i.c/parseInt(rec["åˆè¨ˆ"]))*100).toFixed(1)}%</td></tr>`;
                    });
                    this.loaded=true;
                } catch(e){}
            }
        },
        // 18. æ€§åˆ¥æ¯”
        BrGender: {
            loaded: false, data: [], filtered: [], page: 1, size: 20,
            init: async function(force) {
                if(this.loaded && !force) return;
                try {
                    const res = await fetch(Utils.cors("https://openapi.twse.com.tw/v1/opendata/OpenData_BRK01"));
                    const json = await res.json();
                    this.data = json.filter(i=>!isNaN(parseInt(i["ç¸½äººæ•¸"])) && parseInt(i["ç¸½äººæ•¸"])>0);
                    this.filtered = this.data; this.loaded=true; this.render();
                } catch(e){}
            },
            search: function(v) { this.filtered=this.data.filter(i=>i["è­‰åˆ¸å•†ä»£è™Ÿ"].includes(v)); this.page=1; this.render(); },
            render: function() {
                const tbody = document.getElementById('gender-body'); tbody.innerHTML="";
                this.filtered.slice((this.page-1)*this.size, this.page*this.size).forEach(i=>{
                    const m = parseInt(i["ç”·æ€§å“¡å·¥äººæ•¸"]); const f = parseInt(i["å¥³æ€§å“¡å·¥äººæ•¸"]); const t = parseInt(i["ç¸½äººæ•¸"]);
                    const mp = ((m/t)*100).toFixed(1); const fp = ((f/t)*100).toFixed(1);
                    tbody.innerHTML+=`<tr><td class="stock-code">${i["è­‰åˆ¸å•†ä»£è™Ÿ"]}</td><td>${m}</td><td>${f}</td><td><div class="ratio-bar-container"><div class="male-part" style="width:${mp}%"></div><div class="female-part" style="width:${fp}%"></div></div><div style="font-size:10px;display:flex;justify-content:space-between"><span style="color:#3b82f6">${mp}%</span><span style="color:#f472b6">${fp}%</span></div></td></tr>`;
                });
                document.getElementById('gender-page').innerText = this.page;
            },
            changePage: function(d) { if(this.page+d>0) { this.page+=d; this.render(); } }
        }
    };

    window.onload = function() { Modules.Attention.init(); };
</script>
</body>
</html>
